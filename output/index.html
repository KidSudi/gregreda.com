<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>Greg Reda | Home</title>
	<meta name="google-site-verification" content="AgIAQN_qsniIQWOq659Bnhzx-LZts2FdgP1kLgtQg-k" />
	<meta name="description" content="Greg Reda is a Chicagoan focused on analyzing data to provide insight and drive decisions. He also loves stats, visualization, beer, and music.">
	<meta name="author" content="Greg Reda">

	<!-- Facebook Open Graph
  ================================================== -->
  <meta property="og:title" content="Greg Reda: Data geek in Chicago.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://www.gregreda.com">
  <meta property="og:image" content="http://www.gregreda.com/theme/images/avatar.jpg">
  <meta property="og:description" content="Greg Reda is a Chicagoan focused on analyzing data to provide insight and drive decisions. He also loves stats, visualization, beer, and music.">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="./theme/css/base.css">
	<link rel="stylesheet" href="./theme/css/skeleton.css">
	<link rel="stylesheet" href="./theme/css/layout.css">
	<link rel="stylesheet" href="./theme/css/simply.css">
	<link rel="stylesheet" href="./theme/css/pygments.css">
	<link rel="stylesheet" href="./theme/css/font-awesome.css">
	<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>

	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- JavaScript
	=================================================== -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<!-- <script type="text/javascript">
	  function trackOutboundLink(link, category, action) {
	    try { 
	      _gaq.push(['_trackEvent', category , action]); 
	    } catch(err){}
	   
	    setTimeout(function() { document.location.href = link.href; }, 100);
	  }
	</script> -->

	<!-- Favicons
	================================================== -->
	<!-- <link rel="shortcut icon" href="./theme/images/favicon.ico"> -->
	<link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

</head>
<body>



	<!-- Primary Page Layout
	================================================== -->
	<div class="container">
		<div id="sidebar" class="three columns">
			<a href="."><img id="avatar" src="./theme/images/avatar.jpg"></img></a>
			<h3 id="logo"><a href=".">Greg Reda</a></h3>
	    <p id="bio">Hi. I'm a data analyst at <a href="http://grubhub.com">GrubHub</a> in Chicago. I'm obsessed with all things data, statistics, music, and craft beer.</p>
	    <!-- <br />
	    <p>I analyze data in order to solve problems and provide some useful insights. If you have some curiosities and some data, you should send me an email.</p> -->
	    <hr class="small" /> 
    	<div id="social">
    		<a class="icon" href="https://twitter.com/gjreda" title="Twitter"><i class="icon-twitter"></i></a>
    		<a class="icon" href="https://github.com/gjreda" title="GitHub"><i class="icon-github"></i></a>
    		<a class="icon" href="http://linkedin.com/in/gjreda" title="LinkedIn"><i class="icon-linkedin"></i></a>
				<a class="icon" href="https://last.fm/user/gjreda" title="LastFM"><i class="icon-music"></i></a>
    		<a class="icon" href="mailto:gjreda@gmail.com?subject=Hi" title="E-Mail"><i class="icon-envelope"></i></a>
    		<a class="icon" href="http://www.gregreda.com/feeds/all.atom.xml" title="Subscribe (Atom)"><i class="icon-rss"></i></a>
    	</div> <!-- social -->

		</div> <!-- sidebar -->

		<section id="content" class="twelve columns offset-by-one">
			
  
    <h3 class="article-title"><a href="2013/04/29/more-web-scraping-with-python" title="More web scraping with Python (and a map)">More web scraping with Python (and a map)</a></h3>
    
    <h6 class="article-date">April 29, 2013</h6>

    <!-- <div class="article-summary">
    <p><em>This is a follow-up to my <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/" title="Web Scraping 101 with Python">previous post</a> about web scraping with Python</em>.</p>
<p>Previously, I wrote a basic intro to scraping data off of websites.  Since I wanted to keep the intro fairly simple, I didn't cover storing the data.  In this post, I'll cover the basics of ...</p> <a class="read-more" href="2013/04/29/more-web-scraping-with-python">Read more</a>
    </div> -->
  <!-- <div class="article-content">
    <p><em>This is a follow-up to my <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/" title="Web Scraping 101 with Python">previous post</a> about web scraping with Python</em>.</p>
<p>Previously, I wrote a basic intro to scraping data off of websites.  Since I wanted to keep the intro fairly simple, I didn't cover storing the data.  In this post, I'll cover the basics of writing the scraped data to a flat file and then take things a bit further from there.</p>
<p>Last time, we used the Chicago Reader's Best of 2011 list, but let's change it up a bit this time and scrape a different site.  Why?  Because scrapers break, so we might as well practice a little bit more by scraping something different.</p>
<p>In this post, we're going to use the data from <a href="http://www.chicagomag.com/Chicago-Magazine/November-2012/Best-Sandwiches-Chicago/">Chicago Magazine's Best Sandwiches list</a> because ... who doesn't like sandwiches?</p>
<p>If you're new to scraping, it might be a good idea to go back and read my <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/" title="Web Scraping 101 with Python">previous post</a> as a refresher as I don't intend to be methodical in this one.</p>
<h4>Finding the data</h4>
<p>Looking at the list, it's clear everything is in a fairly standard format - each of the sandwiches in the list gets a <em><code>&lt;div class="sammy"&gt;</code></em> and each div holds a bit more information - specifically, the rank, sandwich name, location, and a URL to a detailed page about each entry.</p>
<p><img alt="Delicious sammy divs" src="/static/images/sammy-divs.png" /></p>
<p>Clicking through a few of the sammy links, we can see that each sandwich also gets a detailed page that includes the sandwich's name, rank, description, and price along with the restaurant's name, address, phone number, and website.  Each of these details is contained within <em><code>&lt;div id="sandwich"&gt;</code></em>, which will make them very easy to get at.</p>
<p><img alt="Sandwich details HTML" src="/static/images/sammy-details.png" /></p>
<h4>Package choices</h4>
<p>We'll again be using the <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a> and <a href="http://docs.python.org/2/library/urllib2.html">urllib2</a> libraries.  Last time around, the choice of these two libraries generated some discussion in the post's <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/#disqus_thread">comments section</a>, on <a href="http://www.reddit.com/r/Python/comments/19lnth/web_scraping_101_with_python_and_beautifulsoup/">Reddit</a>, and <a href="https://news.ycombinator.com/item?id=5353347">Hacker News</a>.</p>
<p>The reason I use <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a> is because I've found it to be very easy to use and understand, but YMMV.  It's been around for a very long time (since 2004) and is certainly in the tool belt of many.  That said, Python has a vast ecosystem with a lot of scraping libraries and ones like <a href="http://scrapy.org/">Scrapy</a> and <a href="http://pythonhosted.org/pyquery/">PyQuery</a> (amongst many others) are worth a look.</p>
<p><a href="http://docs.python.org/2/library/urllib2.html">Urllib2</a> is <em>one</em> of Python's URL handling packages within its standard library.  Because the standard library has <a href="http://docs.python.org/2/library/urllib.html">urllib</a> and <a href="http://docs.python.org/2/library/urllib2.html">urllib2</a>, it has at times been confusing to know which is the one you're actually looking for.  On top of that, <a href="http://kennethreitz.org/">Kenneth Reitz</a>'s fantastic <a href="http://docs.python-requests.org/en/latest/">requests</a> library exists, which really simplifies dealing with HTTP.</p>
<p>In this example, and in the previous one, I use urllib2 simply because I <em>only</em> need the <a href="http://docs.python.org/2/library/urllib2.html#urllib2.urlopen">urlopen</a> function.  If this scraper were more complex, I would likely use <a href="http://docs.python-requests.org/en/latest/">requests</a>, but I think using a third party library is a bit of overkill for this very simple use case.</p>
<h4>Getting the data</h4>
<p>Our code this time is going to be very similar to what it was <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/" title="Web Scraping 101 with Python">in the previous post</a>, save for a few minor changes.  Since the details pages have the data we're looking for, let's get all of their URLs from the initial list page, and then process each details page.  We're also going to write all of the data to a tab-delimited file using Python's <a href="http://docs.python.org/2/library/csv.html">CSV</a> package.</p>
<p>Last time around, we wrote our code as a set of functions, which I think helps the code's readability since it makes clear what each piece of the code is doing.  This time around, we're just going to write a short script since this is really a one-off thing - once we have our data written to a CSV, we don't really have a use for this code anymore.</p>
<p>Our script will do the following:</p>
<ol>
<li>Load our libraries</li>
<li>Read our <em>base_url</em> into a BeautifulSoup object, grab all <em><code>&lt;div class="sammy"&gt;</code></em> sections, and then from each section, grab our sammy details URL.</li>
<li>Open up a file named <em>src-best-sandwiches.tsv</em> for writing.  We'll write to this file using Python's <a href="http://docs.python.org/2/library/csv.html#csv.writer">csv.writer</a> object and separate the fields by a tab (\t).  We'll also pass in a list of field names so that our file has a header row.</li>
<li>Loop through all of our sammy details URLs, grabbing each piece of information we're interested in, and writing that data to our <em>src-best-sandwiches.tsv</em> file.</li>
</ol>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;http://www.chicagomag.com/Chicago-Magazine/&quot;</span>
            <span class="s">&quot;November-2012/Best-Sandwiches-Chicago/&quot;</span><span class="p">)</span>

<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">sammies</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">,</span> <span class="s">&quot;sammy&quot;</span><span class="p">)</span>
<span class="n">sammy_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">div</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s">&quot;href&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">sammies</span><span class="p">]</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;data/src-best-sandwiches.tsv&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;rank&quot;</span><span class="p">,</span> <span class="s">&quot;sandwich&quot;</span><span class="p">,</span> <span class="s">&quot;restaurant&quot;</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">,</span> <span class="s">&quot;price&quot;</span><span class="p">,</span>
                    <span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;phone&quot;</span><span class="p">,</span> <span class="s">&quot;website&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">fieldnames</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">sammy_urls</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;http://www.chicagomag.com&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>  <span class="c"># inconsistent URL</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.chicagomag.com{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="s">&quot;sandwich&quot;</span><span class="p">})</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="s">&quot;sandRank&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">sandwich</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;&lt;br/&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">restaurant</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">addy</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;addy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">addy</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">addy</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;addy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;addy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">a</span><span class="p">:</span>
            <span class="n">website</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;addy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">encode_contents</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">website</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">output</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">rank</span><span class="p">,</span> <span class="n">sandwich</span><span class="p">,</span> <span class="n">restaurant</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span>
                        <span class="n">address</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">website</span><span class="p">])</span>

<span class="k">print</span> <span class="s">&quot;Done writing file&quot;</span>
</pre></div>


<p>While our scraper does a good job of getting all of the sandwiches and restaurants, a couple of restaurants had "multiple locations" listed as their address.  If we were to need this data, we'll have to find another way to get it (like checking each restaurant's website and manually adding their locations to our dataset).  We'll also need to manually fix some oddities that wound up in our data due some inconsistent HTML on the other end (addresses and URLs winding up in the phone numbers column).</p>
<p>We're now left with a file full of data about Chicago Magazine's fifty best sandwiches.  Sure, it's nice to have the data structured neatly in a flat file, but that's not all that interesting.</p>
<p>Collecting and hoarding data isn't of use to anyone - it's a waste of a potentially very valuable resource - it needs to be taken a step further.  In some cases, this means a thorough analysis in search of patterns and trends, surfacing relationships we did not necessarily expect, and utilizing that information to better our decision-making.  Data should be used to inform.  In some cases, even a very basic visualization of the data can be of use.</p>
<p>Since we have addresses for each restaurant, this seems like a great time to make a map, but first, geocoding!</p>
<h4>Geocoding</h4>
<p>We're going to make our map using the <a href="https://developers.google.com/maps/">Google Maps API</a>, but in order to do so, we're first going to need to geocode our addresses to a set of lat/long points.  Don't worry, I've taken the time to manually fill in the blanks on those "multiple locations" restaurants (you can grab the new file from my <a href="https://github.com/gjreda/best-sandwiches">GitHub repo</a> - it's called <em>best-sandwiches.tsv</em>).</p>
<p>To do so, we'll just write a short Python script which hits the <a href="https://developers.google.com/maps/documentation/geocoding/">Google Geocoding API</a>.  Our script will do the following:</p>
<ol>
<li>Read our <em>best-sandwiches.tsv</em> file using the CSV module's <a href="http://docs.python.org/2/library/csv.html#csv.DictReader">DictReader</a> class, which reads each line of the file into its own dictionary object.</li>
<li>For each address, make a call to the Google Geocoding API, which will return a JSON response full of details about that address.</li>
<li>Using the <a href="http://docs.python.org/2/library/csv.html#csv.DictWriter">DictWriter</a> class, write a new file with our data along with the formatted address, lat, and long that we got back from the geocoder.</li>
</ol>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">geocode</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;http://maps.googleapis.com/maps/api/geocode/json?&quot;</span>
        <span class="s">&quot;sensor=false&amp;address={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;data/best-sandwiches.tsv&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;data/best-sandwiches-geocode.tsv&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;rank&quot;</span><span class="p">,</span> <span class="s">&quot;sandwich&quot;</span><span class="p">,</span> <span class="s">&quot;restaurant&quot;</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">,</span> <span class="s">&quot;price&quot;</span><span class="p">,</span>
                 <span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;city&quot;</span><span class="p">,</span> <span class="s">&quot;phone&quot;</span><span class="p">,</span> <span class="s">&quot;website&quot;</span><span class="p">,</span> <span class="s">&quot;full_address&quot;</span><span class="p">,</span>
                 <span class="s">&quot;formatted_address&quot;</span><span class="p">,</span> <span class="s">&quot;lat&quot;</span><span class="p">,</span> <span class="s">&quot;lng&quot;</span><span class="p">]</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Geocoding: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s">&quot;full_address&quot;</span><span class="p">])</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">geocode</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s">&quot;full_address&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">u&quot;OK&quot;</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;results&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;formatted_address&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s">&quot;formatted_address&quot;</span><span class="p">]</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s">&quot;geometry&quot;</span><span class="p">][</span><span class="s">&quot;location&quot;</span><span class="p">][</span><span class="s">&quot;lat&quot;</span><span class="p">]</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;lng&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s">&quot;geometry&quot;</span><span class="p">][</span><span class="s">&quot;location&quot;</span><span class="p">][</span><span class="s">&quot;lng&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;formatted_address&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&quot;lng&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;Done writing file&quot;</span>
</pre></div>


<p>Our file now has everything we need to make our map, which we're able to do with some basic HTML, CSS, JavaScript, and a little <a href="https://developers.google.com/fusiontables/">Google Fusion Tables</a> magic.</p>
<h4>Mapping</h4>
<p>While we could write another Python script to turn our flat file data into KML for mapping, it's much, much easier to use Google Fusion Tables.  However, one important note with the Fusion Tables approach is that the underlying data must be within a <em>public</em> Fusion Table.  Since our data is scraped from a publicly accessible website, that's not an issue here.</p>
<p>If you don't see Fusion Table as an option in your Google Drive account, you'll need to "connect more apps" and add it from there.</p>
<p><img alt="Adding Fusion Tables" src="/static/images/add-fusion-tables.png" /></p>
<p>Once you've added the app, create a new Fusion Table from the delimited file on your computer (our <em>best-sandwiches-geocode.tsv</em>).</p>
<p><img alt="Loading to Fusion Tables" src="/static/images/loading-to-fusion-tables.png" /></p>
<p>After you've finished your upload process, you should now have a spreadsheet-like table with the data in it.  You'll notice that some of the columns are highlighted in yellow - this means that Fusion Tables is recognizing that it's a location.  Our lat and lng columns should be all the way at the right - hover over the lat column header and select <em>change</em> from the drop down.  This should display a prompt showing us the column type is a two column location comprised of both our lat and lng.</p>
<p>This is probably where I should point out that we could have also used Fusion Tables to geocode our data, but writing a script in Python seemed like more fun to me.</p>
<p><img alt="Lat Lng column type" src="/static/images/lat-lng-column-type.png" /></p>
<p>Now that we have our data successfully in the Fusion Table, we can use a combination HTML, CSS, some JavaScript, and the Fusion Tables API to serve up a map (you could also just click the map tab in Fusion Tables to see an embedded map of the data, but that's not as fun).  We can even style the map with the <a href="http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html">Google Maps Style Wizard</a>.</p>
<p>Head over to my <a href="https://github.com/gjreda/best-sandwiches">GitHub repo</a> to see the HTML, CSS, and JavaScript used to create the map (along with the rest of the code and data used throughout this post).  I've done my best to comment the <em>best-sandwiches.html</em> file to indicate what each piece is doing.  I've also used HTML5's geolocation capabilities so that fellow Chicagoans can easily see which sandwiches are near them (it displays pretty nicely on a mobile browser, too).</p>
<p>You can check out the awesome map we made <a href="http://www.gregreda.com/best-sandwiches.html">here</a>.  Note that if you aren't in Chicago and let your browser know your location, you likely won't see any of the data - you'll have to scroll over to Chicago.</p>
<p>Hopefully you found this post fun and informative.  Was there something I didn't cover?  Let me know in the comments.</p>
  </div> -->
  <hr class="large">
  
  
    <h3 class="article-title"><a href="2013/03/16/why-you-should-write-online" title="Write online about what you love">Write online about what you love</a></h3>
    
    <h6 class="article-date">March 16, 2013</h6>

    <!-- <div class="article-summary">
    <p>The other week, I wrote a <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/">very basic intro to web scraping with Python</a>.  Some friends knew that I had experience scraping data and they wanted to learn, so I figured it would be a great opportunity to write something publicly and test how well I could explain it.</p>
<p>I ...</p> <a class="read-more" href="2013/03/16/why-you-should-write-online">Read more</a>
    </div> -->
  <!-- <div class="article-content">
    <p>The other week, I wrote a <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/">very basic intro to web scraping with Python</a>.  Some friends knew that I had experience scraping data and they wanted to learn, so I figured it would be a great opportunity to write something publicly and test how well I could explain it.</p>
<p>I'll be extending that scraping post a bit more in the future, but first I wanted to write about how the week and a half since I posted it has gone - or, explain why I think you should write online about what you love.</p>
<h4>How it started</h4>
<p>Shortly after finishing the post and feeling fairly satisfied with the way it turned out, I posted it and e-mailed a link to three of my friends - two of which were the ones who asked me to teach them.  One of them, <a href="https://twitter.com/kennylong">Kenny</a>, immediately messaged me, read through the post, and said I should share it on Twitter.  <a href="https://twitter.com/gjreda/status/308337050065727489">So I did</a>.  To me, any feedback was better than no feedback, so I posted it <a href="http://www.reddit.com/r/Python/comments/19lnth/web_scraping_101_with_python_and_beautifulsoup/">in the Python subreddit</a> too.</p>
<p>I was really just hoping some people would see it and let me know what they thought.</p>
<p>Turns out, quite a few more people than my 92 followers (at the time) have seen it in the week and a half since.  About 32,000 more.</p>
<p><img alt="Initial traffic from Twitter and /r/python" src="/static/images/initial-traffic-20130313.png" /></p>
<p>It was pretty exhilarating to watch something I wrote be shared in real-time.  Many of the <a href="https://twitter.com/siah/status/308719789524799488">data</a> <a href="https://twitter.com/treycausey/status/308342790180458496">nerds</a> that I admire and follow on Twitter were sharing it.  Hell, even Philadelphia's Chief Data Officer <a href="https://twitter.com/mheadd/status/308576308810637312">shared it</a>.  It was a ton of fun to watch and read both (fairly) positive and constructive comments about it on /r/python.  It immediately made me want to write the post you're currently reading, which I started working on two days later.</p>
<h4>A week later</h4>
<p>Sitting around the following Sunday, making minor CSS tweaks to this site and finishing up the previously mentioned post, I decided to check my Google Analytics to see what the final traffic from /r/python and Twitter looked like.  Surprisingly, the real-time section of Analytics showed 250+ on the site.  What?  How?!</p>
<p>That's when I realized it wound up at the top of <a href="https://news.ycombinator.com/item?id=5353347">Hacker News</a>.  And then <a href="http://www.reddit.com/r/programming/comments/1a20lf/web_scraping_101_with_python/">/r/programming</a>.  Traffic went through the roof.</p>
<p><img alt="Hacker News, /r/programming, and lots of Twitter sharing" src="/static/images/more-traffic-20130313.png" /></p>
<p>And again, the comments were positive and constructive.</p>
<h4>Lesson learned</h4>
<p>And this leads me to why you should write about things you're passionate about online.  When you're truly passionate about something, you spend a lot of time thinking and learning about it - you try to make it a part of your life.  You try to become reputable source on the topic (or even an expert).  It can be something as broad as beer, personal finance, or film; or as niche as stand-up comedy, vegan baking, or <a href="http://en.wikipedia.org/wiki/Emo#Underground_popularity:_mid-1990s">90s midwest emo bands</a> (guilty).  It doesn't matter what it is as long as <em>you</em> love it.</p>
<p>Like me, you're likely ecstatic when you find someone you're able to get nerdy with about something you love.  You truly enjoy the topic and are always looking for ways to <em>learn more</em> and <em>teach others</em> about it (or just banter).</p>
<p>That's why you should share your knowledge about whatever the field may be.  <em>It doesn't matter whether 10 or 10,000 people see what you've shared</em>.  There are people interested, but might not know where to start.  And that's the best way to reinforce how well we know something - by teaching it to others.  You'll be prompted with questions you hadn't thought about before, which will only further your own curiosity.  You're forced to explain concepts in simple terms that anyone can understand - you become a better teacher and communicator.  Sometimes, someone else crazily passionate about the same topic will even come along and teach you a thing or two.</p>
<p>We all have a thirst for knowledge in some form.  The internet's a magnificent place to test our existing knowledge by teaching others and learning more throughout the process thanks to feedback from those with differing experiences.</p>
<p>Put your passions out there.  More often than not, you'll be amazed at what you get back.</p>
  </div> -->
  <hr class="large">
  
  
    <h3 class="article-title"><a href="2013/03/03/web-scraping-101-with-python" title="Web Scraping 101 with Python">Web Scraping 101 with Python</a></h3>
    
    <h6 class="article-date">March 03, 2013</h6>

    <!-- <div class="article-summary">
    <p>Yea, yea, I know I said I was going to <a href="http://www.gregreda.com/2013/01/23/translating-sql-to-pandas-part1/">write more</a> on <a href="http://pandas.pydata.org">pandas</a>, but recently I've had a couple friends ask me if I could teach them how to scrape data.  While they said they were able to find a ton of resources online, all assumed some level ...</p> <a class="read-more" href="2013/03/03/web-scraping-101-with-python">Read more</a>
    </div> -->
  <!-- <div class="article-content">
    <p>Yea, yea, I know I said I was going to <a href="http://www.gregreda.com/2013/01/23/translating-sql-to-pandas-part1/">write more</a> on <a href="http://pandas.pydata.org">pandas</a>, but recently I've had a couple friends ask me if I could teach them how to scrape data.  While they said they were able to find a ton of resources online, all assumed some level of knowledge already.  Here's my attempt at assuming a very minimal knowledge of programming.</p>
<h4>Getting Setup</h4>
<p>We're going to be using Python 2.7, <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>, and <a href="http://lxml.de/">lxml</a>.  If you don't already have Python 2.7, you'll want to download the proper version for your OS <a href="http://python.org/download/releases/2.7.3/">here</a>.</p>
<p>To check if you have Python 2.7 on OSX, open up <a href="http://en.wikipedia.org/wiki/Terminal_(OS_X)">Terminal</a> and type <em>python --version</em>.  You should see something like this:</p>
<p><img alt="What Terminal should looks like" src="/static/images/python-version.png" /></p>
<p>Next, you'll need to install <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>.  If you're on OSX, you'll already have <a href="http://pypi.python.org/pypi/setuptools">setuptools</a> installed.  Let's use it to install <a href="http://www.pip-installer.org/en/latest/">pip</a> and use that for package management instead.</p>
<p>In Terminal, run <em>sudo easy_install pip</em>.  You'll be prompted for your password - type it in and let it run.  Once that's done, again in Terminal, <em>sudo pip install BeautifulSoup4</em>.  Finally, you'll need to <a href="http://lxml.de/installation.html">install lxml</a>.</p>
<h4>A few scraping rules</h4>
<p>Now that we have the packages we need, we can start scraping.  But first, a couple of rules.</p>
<ol>
<li>You should check a site's terms and conditions before you scrape them.  It's their data and they likely have some rules to govern it.</li>
<li>Be nice - A computer will send web requests much quicker than a user can.  Make sure you space out your requests a bit so that you don't hammer the site's server.</li>
<li>Scrapers break - Sites change their layout all the time.  If that happens, be prepared to rewrite your code.</li>
<li>Web pages are inconsistent - There's sometimes some manual clean up that has to happen even after you've gotten your data.</li>
</ol>
<h4>Finding your data</h4>
<p>For this example, we're going to use the <a href="http://www.chicagoreader.com/chicago/best-of-chicago-2011/BestOf?oid=4100483">Chicago Reader's Best of 2011</a> list.  Why?  Because I think it's a great example of terrible data presentation on the web.  Go ahead and browse it for a bit.</p>
<p>All you want to see is a list of the category, winner, and maybe the runners-up, right?  But you have to continuously click link upon link, slowly navigating your way through the list.</p>
<p>Hopefully in your clicking you noticed the important thing though - all the pages are structured the same.</p>
<h4>Planning your code</h4>
<p>In looking at the <a href="http://www.chicagoreader.com/chicago/best-of-chicago-2011-food-drink/BestOf?oid=4106228">Food and Drink</a> section of the Best of 2011 list, we see that all the categories are a link.  Each of those links has the winner, maybe some information about the winner (like an address), and the runners-up.  It's probably a good idea to break these things into separate functions in our code.</p>
<p>To start, we need to take a look at the HTML that displays these categories.  If you're in Chrome or Firefox, highlight "Readers' Poll Winners", right-click, and select Inspect Element.</p>
<p><img alt="Inspect Element" src="/static/images/inspect-element.png" /></p>
<p>This opens up the browser's Developer Tools (in Firefox, you might now have to click the HTML button on the right side of the developer pane to fully show it).  Now we'll be able to see the page layout.  The browser has brought us directly to the piece of HTML that's used to display the "Readers' Poll Winners" <em><code>&lt;dt&gt;</code></em> element.</p>
<p><img alt="Inspect Element some more" src="/static/images/inspect-element-more.png" /></p>
<p>This seems to be the area of code where there's going to be some consistency in how the category links are displayed.  See that <em><code>&lt;dl class="boccat"&gt;</code></em> just above our "Readers' Poll Winners" line?  If you mouse over that line in your browser's dev tools, you'll notice that it highlights the <strong>entire section</strong> of category links we want.  And every category link is within a <em><code>&lt;dd&gt;</code></em> element.  Perfect!  Let's get all of them.</p>
<p><img alt="Inspect Element mouse over" src="/static/images/inspect-element-mouseover.png" /></p>
<h4>Our first function - getting the category links</h4>
<p>Now that we know we know the <em><code>&lt;dl class="boccat"&gt;</code></em> section holds all the links we want, let's write some code to find that section, and then grab all of the links within the <em><code>&lt;dd&gt;</code></em> elements of that section.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s">&quot;http://www.chicagoreader.com&quot;</span>

<span class="k">def</span> <span class="nf">get_category_links</span><span class="p">(</span><span class="n">section_url</span><span class="p">):</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">section_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s">&quot;lxml&quot;</span><span class="p">)</span>
    <span class="n">boccat</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;dl&quot;</span><span class="p">,</span> <span class="s">&quot;boccat&quot;</span><span class="p">)</span>
    <span class="n">category_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s">&quot;href&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">boccat</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&quot;dd&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">category_links</span>
</pre></div>


<p>Hopefully this code is relatively easy to follow, but if not, here's what we're doing:</p>
<ol>
<li>Loading the urlopen function from the urllib2 library into our local <a href="http://en.wikipedia.org/wiki/Namespace_(computer_science)">namespace</a>.</li>
<li>Loading the BeautifulSoup class from the bs4 (BeautifulSoup4) library into our local namespace.</li>
<li>Setting a variable named <em>BASE_URL</em> to "http://www.chicagoreader.com".  We do this because the links used through the site are relative - meaning they do not include the base domain.  In order to store our links properly, we need to concatenate the base domain with each relative link.</li>
<li>Define a function named <em>get_category_links</em>.<ol>
<li>The function requires a parameter of <em>section_url</em>.  In this example, we're going to use the <a href="http://www.chicagoreader.com/chicago/best-of-chicago-2011-food-drink/BestOf?oid=4106228">Food and Drink</a> section of the BOC list, however we could use a different section URL - for instance, the <a href="http://www.chicagoreader.com/chicago/best-of-chicago-2011-city-life/BestOf?oid=4106233">City Life</a> section's URL.  We're able to create just one generic function because each section page is structured the same.</li>
<li>Open the section_url and read it in the <em>html</em> object.</li>
<li>Create an object called <em>soup</em> based on the BeautifulSoup class.  The <em>soup</em> object is an <a href="http://en.wikipedia.org/wiki/Instance_(computer_science)">instance</a> of the BeautifulSoup class.  It is initialized with the html object and parsed with <a href="http://lxml.de/">lxml</a>.</li>
<li>In our BeautifulSoup instance (which we called <em>soup</em>), find the <em><code>&lt;dl&gt;</code></em> element with a class of "boccat" and store that section in a variable called <em>boccat</em>.</li>
<li>This is a <a href="http://docs.python.org/2/tutorial/datastructures.html#list-comprehensions">list comprehension</a>.  For every <em><code>&lt;dd&gt;</code></em> element found within our <em>boccat</em> variable, we're getting the href of its <em><code>&lt;a&gt;</code></em> element (our category links) and concatenating on our <em>BASE_URL</em> to make it a complete link.  All of these links are being stored in a list called <em>category_links</em>.  You could also write this line with a <a href="http://docs.python.org/2/tutorial/controlflow.html#for-statements">for loop</a>, but I prefer a list comprehension here because of its simplicity.</li>
<li>Finally, our function returns the <em>category_links</em> list that we created on the previous line.</li>
</ol>
</li>
</ol>
<h4>Our second function - getting the category, winner, and runners-up</h4>
<p>Now that we have our list of category links, we'd better start going through them to get our winners and runners-up.  Let's figure out which elements contain the parts we care about.</p>
<p>If we look at the <a href="http://www.chicagoreader.com/chicago/best-chef/BestOf?oid=4088191">Best Chef</a> category, we can see that our category is in <em><code>&lt;h1 class="headline"&gt;</code></em>.  Shortly after that, we find our winner and runners-up stored in <em><code>&lt;h2 class="boc1"&gt;</code></em> and <em><code>&lt;h2 class="boc2"&gt;</code></em>, respectively.</p>
<p><img alt="Finding our winners and runners-up" src="/static/images/winners-and-runners-up.png" /></p>
<p>Let's write some code to get all of them.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_category_winner</span><span class="p">(</span><span class="n">category_url</span><span class="p">):</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">category_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s">&quot;lxml&quot;</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;h1&quot;</span><span class="p">,</span> <span class="s">&quot;headline&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span>
    <span class="n">winner</span> <span class="o">=</span> <span class="p">[</span><span class="n">h2</span><span class="o">.</span><span class="n">string</span> <span class="k">for</span> <span class="n">h2</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&quot;h2&quot;</span><span class="p">,</span> <span class="s">&quot;boc1&quot;</span><span class="p">)]</span>
    <span class="n">runners_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">h2</span><span class="o">.</span><span class="n">string</span> <span class="k">for</span> <span class="n">h2</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&quot;h2&quot;</span><span class="p">,</span> <span class="s">&quot;boc2&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
            <span class="s">&quot;category_url&quot;</span><span class="p">:</span> <span class="n">category_url</span><span class="p">,</span>
            <span class="s">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span>
            <span class="s">&quot;runners_up&quot;</span><span class="p">:</span> <span class="n">runners_up</span><span class="p">}</span>
</pre></div>


<p>It's very similar to our last function, but let's walk through it anyway.</p>
<ol>
<li>Define a function called <em>get_category_winner</em>.  It requires a <em>category_url</em>.</li>
<li>Lines two and three are actually exactly the same as before - we'll come back to this in the next section.</li>
<li>Find the string within the <em><code>&lt;h1 class="headline"&gt;</code></em> element and store it in a variable named category.</li>
<li>Another list comprehension - store the string within every <em><code>&lt;h2 class="boc1"&gt;</code></em> element in a list called <em>winner</em>.  But shouldn't there be only one winner?  You'd think that, but some have multiple (e.g. <a href="http://www.chicagoreader.com/chicago/best-bang-for-your-buck/BestOf?oid=4088018">Best Bang for your Buck</a>).</li>
<li>Same as the previous line, but this time we're getting the runners-up.</li>
<li>Finally, return a <a href="http://docs.python.org/2/tutorial/datastructures.html#dictionaries">dictionary</a> with our data.</li>
</ol>
<h4>DRY - Don't Repeat Yourself</h4>
<p>As mentioned in the previous section, lines two and three of our second function mirror lines in our first function.</p>
<p>Imagine a scenario where we want to change the parser we're passing into our BeautifulSoup instance (in this case, lxml).  With the way we've currently written our code, we'd have to make that change in two places.  Now imagine you've written many more functions to scrape this data - maybe one to get addresses and another to get <a href="http://www.chicagoreader.com/chicago/best-new-food-truckfood/BestOf?oid=4101387">paragraphs of text about the winner</a> - you've likely repeated those same two lines of code in these functions and you now have to remember to make changes in four different places.  That's not ideal.</p>
<p>A good principle in writing code is <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY - Don't Repeat Yourself</a>.  When you notice that you've written the same lines of code a couple times throughout your script, it's probably a good idea to step back and think if there's a better way to structure that piece.</p>
<p>In our case, we're going to write another function to simply process a URL and return a BeautifulSoup instance.  We can then call this function in our other functions instead of duplicating our logic.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">make_soup</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s">&quot;lxml&quot;</span><span class="p">)</span>
</pre></div>


<p>We'll have to change our other functions a bit now, but it's pretty minor - we just need to replace our duplicated lines with the following:</p>
<div class="codehilite"><pre><span class="n">soup</span> <span class="o">=</span> <span class="n">make_soup</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="c"># where url is the url we&#39;re passing into the original function</span>
</pre></div>


<h4>Putting it all together</h4>
<p>Now that we have our main functions written, we can write a script to output the data however we'd like.  Want to write to a CSV file?  Check out Python's <a href="http://docs.python.org/2/library/csv.html#csv.DictWriter">DictWriter</a> class.  Storing the data in a database?  Check out the <a href="http://docs.python.org/2/library/sqlite3.html">sqlite3</a> or <a href="http://wiki.python.org/moin/DatabaseInterfaces">other various database libraries</a>.  While both tasks are somewhat outside of my intentions for this post, if there's interest, let me know in the comments and I'd be happy to write more.</p>
<p>Hopefully you found this post useful.  I've put a final example script in <a href="http://bit.ly/13yd9ng">this gist</a>.</p>
<p><em>Read my follow-up to this post <a href="http://www.gregreda.com/2013/04/29/more-web-scraping-with-python/">here</a>.</em></p>
  </div> -->
  <hr class="large">
  
  
    <h3 class="article-title"><a href="2013/01/23/translating-sql-to-pandas-part1" title="Translating SQL to Pandas, Part 1">Translating SQL to Pandas, Part 1</a></h3>
    
    <h6 class="article-date">January 23, 2013</h6>

    <!-- <div class="article-summary">
    <p>For some reason, I've always found SQL to a much more intuitive tool for exploring a tabular dataset than I have other languages (namely R and Python).</p>
<p>If you know SQL well, you can do a whole lot with it, and since data is often in a relational database ...</p> <a class="read-more" href="2013/01/23/translating-sql-to-pandas-part1">Read more</a>
    </div> -->
  <!-- <div class="article-content">
    <p>For some reason, I've always found SQL to a much more intuitive tool for exploring a tabular dataset than I have other languages (namely R and Python).</p>
<p>If you know SQL well, you can do a whole lot with it, and since data is often in a relational database anyway, it usually makes sense to stick with it.  I find that my workflow often includes writing a lot of queries in SQL (using <a href="http://www.sequelpro.com/">Sequel Pro</a>) to get the data the way I want it, reading it into R (with <a href="http://www.rstudio.com/">RStudio</a>), and then maybe a bit more exploration, modeling, and visualization (with <a href="http://ggplot2.org/">ggplot2</a>).</p>
<p>Not too long ago though, I came across <a href="http://blog.wesmckinney.com/">Wes McKinney</a>'s <a href="http://pandas.pydata.org">pandas</a> package and my interest was immediately piqued.  Pandas adds a bunch of functionality to Python, but most importantly, it allows for a DataFrame data structure - much like a database table or R's data frame.</p>
<p>Given the great things I've been reading about pandas lately, I wanted to make a conscious effort to play around with it.  Instead of my typical workflow being a couple disjointed steps with SQL + R + (sometimes) Python, my thought is that it might make sense to have pandas work its way in and take over the R work.  While I probably won't be able to completely give up R (too much ggplot2 love over here), I get bored if I'm not learning something new, so pandas it is.</p>
<p>I intend to document the process a bit - hopefully a couple posts illustrating the differences between SQL and pandas (and maybe some R too).</p>
<p>Throughout the rest of this post, we're going to be working with data from the <a href="https://data.cityofchicago.org">City of Chicago's open data</a> - specifically the <a href="https://data.cityofchicago.org/Transportation/Towed-Vehicles/ygr5-vcbg">Towed Vechicles data</a>.</p>
<h4>Loading the data</h4>
<h5>Using SQLite</h5>
<p>To be able to use SQL with this dataset, we'd first have to create the table.  Using <a href="http://www.sqlite.org/">SQLite</a> syntax, we'd run the following:</p>
<div class="codehilite"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">towed</span> <span class="p">(</span>
    <span class="n">tow_date</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">make</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">style</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">model</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">color</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">plate</span> <span class="nb">text</span><span class="p">,</span>
    <span class="k">state</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">towed_address</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">phone</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">inventory</span> <span class="nb">text</span>
<span class="p">);</span>
</pre></div>


<p>Because SQLite <a href="http://www.sqlite.org/datatype3.html">uses a very generic type system</a>, we don't get the strict data types that we would in most other databases (such as MySQL and PostgreSQL); therefore, all of our data is going to be stored as text.  In other databases, we'd store tow_date as a date or datetime field.</p>
<p>Before we read the data into SQLite, we need to tell the database to that the fields are separated by a comma.  Then we can use the import command to read the file into our table.</p>
<div class="codehilite"><pre><span class="p">.</span><span class="n">separator</span> <span class="s1">&#39;,&#39;</span>
<span class="p">.</span><span class="n">import</span> <span class="p">.</span><span class="o">/</span><span class="n">Towed_Vehicles</span><span class="p">.</span><span class="n">csv</span> <span class="n">towed</span>
</pre></div>


<p>Note that the downloaded CSV contains two header rows, so we'll need to delete those from our table since we don't need them.</p>
<div class="codehilite"><pre><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">WHERE</span> <span class="n">tow_date</span> <span class="o">=</span> <span class="s1">&#39;Tow Date&#39;</span><span class="p">;</span>
</pre></div>


<p>We should have 5,068 records in our table now (note: the City of Chicago regularly updates this dataset, so you might get a different number).</p>
<div class="codehilite"><pre><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">towed</span><span class="p">;</span> <span class="c1">-- 5068</span>
</pre></div>


<h5>Using Python + pandas</h5>
<p>Let do the same with <a href="http://pandas.pydata.org">pandas</a> now.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;tow_date&quot;</span><span class="p">,</span> <span class="s">&quot;make&quot;</span><span class="p">,</span> <span class="s">&quot;style&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="s">&quot;color&quot;</span><span class="p">,</span> <span class="s">&quot;plate&quot;</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">,</span>
    <span class="s">&quot;towed_address&quot;</span><span class="p">,</span> <span class="s">&quot;phone&quot;</span><span class="p">,</span> <span class="s">&quot;inventory&quot;</span><span class="p">]</span>
<span class="n">towed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">&quot;Towed_Vehicles.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">col_names</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;tow_date&quot;</span><span class="p">])</span>
</pre></div>


<p>The read_csv function in pandas actually allowed us to skip the two header columns and translate the tow_date field to a datetime field.</p>
<p>Let's check our count just to make sure.</p>
<div class="codehilite"><pre><span class="nb">len</span><span class="p">(</span><span class="n">towed</span><span class="p">)</span> <span class="c"># 5068</span>
</pre></div>


<h4>Selecting data</h4>
<h5>SQL</h5>
<p>Selection data with SQL is fairly intuitive - just SELECT the columns you want FROM the particular table you're interested in.  You can also take advantage of the LIMIT clause to only see a subset of your data.</p>
<div class="codehilite"><pre><span class="c1">-- Return every column for every record in the towed table</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span><span class="p">;</span>

<span class="c1">-- Return the tow_date, make, style, model, and color for every record in the towed table</span>
<span class="k">SELECT</span> <span class="n">tow_date</span><span class="p">,</span> <span class="n">make</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">color</span> <span class="k">FROM</span> <span class="n">towed</span><span class="p">;</span>

<span class="c1">-- Return every column for the first five records of the towed table</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">;</span>

<span class="c1">-- Return every column in the towed table - start at the fifth record and show the next ten</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">-- records 5-14</span>
</pre></div>


<p>Additionally, you can throw a WHERE or ORDER BY (or both) into your queries for proper filtering and ordering of the data returned:</p>
<div class="codehilite"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">WHERE</span> <span class="k">state</span> <span class="o">=</span> <span class="s1">&#39;TX&#39;</span><span class="p">;</span> <span class="c1">-- Only towed vehicles from Texas</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">WHERE</span> <span class="n">make</span> <span class="o">=</span> <span class="s1">&#39;KIA&#39;</span> <span class="k">AND</span> <span class="k">state</span> <span class="o">=</span> <span class="s1">&#39;TX&#39;</span><span class="p">;</span> <span class="c1">-- KIAs with Texas plates</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">towed</span> <span class="k">WHERE</span> <span class="n">make</span> <span class="o">=</span> <span class="s1">&#39;KIA&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">color</span><span class="p">;</span> <span class="c1">-- All KIAs ordered by color (A to Z)</span>
</pre></div>


<h5>Python + pandas</h5>
<p>Let's do some of the same, but this time let's use pandas:</p>
<div class="codehilite"><pre><span class="c"># show only the make column for all records</span>
<span class="n">towed</span><span class="p">[</span><span class="s">&quot;make&quot;</span><span class="p">]</span>

<span class="c"># tow_date, make, style, model, and color for the first ten records</span>
<span class="n">towed</span><span class="p">[[</span><span class="s">&quot;tow_date&quot;</span><span class="p">,</span> <span class="s">&quot;make&quot;</span><span class="p">,</span> <span class="s">&quot;style&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="s">&quot;color&quot;</span><span class="p">]][:</span><span class="mi">10</span><span class="p">]</span>

<span class="n">towed</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="c"># first five rows (alternatively, you could use towed.head())</span>
</pre></div>


<p>Because pandas is built on top of <a href="http://www.numpy.org/">NumPy</a>, we're able to use <a href="http://pandas.pydata.org/pandas-docs/dev/indexing.html#boolean-indexing">boolean indexing</a>.  Since we're going to replicate similar statements to the ones we did in SQL, we know we're going to need towed cars from TX made by KIA.</p>
<div class="codehilite"><pre><span class="n">towed</span><span class="p">[</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;TX&quot;</span><span class="p">]</span> <span class="c"># all columns and records where the car was from TX</span>

<span class="n">towed</span><span class="p">[(</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;TX&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;make&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;KIA&quot;</span><span class="p">)]</span> <span class="c"># made by KIA AND from TX</span>

<span class="n">towed</span><span class="p">[(</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;MA&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;make&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;JAGU&quot;</span><span class="p">)]</span> <span class="c"># made by Jaguar OR from MA</span>

<span class="n">towed</span><span class="p">[</span><span class="n">towed</span><span class="p">[</span><span class="s">&quot;make&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;KIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span> <span class="c"># made by KIA, ordered by color (A to Z)</span>
</pre></div>


<h5>Conclusion, Part 1</h5>
<p>This was obviously a very basic start, but there are a lot of good things about pandas - it's certainly concise and readable.  Plus, since it works well with the various science + math packages (<a href="http://www.scipy.org">SciPy</a>, <a href="http://www.numpy.org/">NumPy</a>, <a href="http://matplotlib.org/">Matplotlib</a>, <a href="http://statsmodels.sourceforge.net/">statsmodels</a>, etc.), there's the potential to work almost entirely in one language for analysis tasks.</p>
<p>I plan on covering aggregate functions, pivots, and maybe some matplotlib in my next post.</p>
  </div> -->
  <hr class="large">
  
  
    <h3 class="article-title"><a href="2013/01/22/hello-world" title="Hello World">Hello World</a></h3>
    
    <h6 class="article-date">January 22, 2013</h6>

    <!-- <div class="article-summary">
    <p>So I finally got around to putting something of my own up.</p>
<p>My intentions are mainly to use this space as a way to document mini projects that I'm working on, so plan on it being pretty programming, data, visualization, and statistics heavy - I get bored if I'm ...</p> <a class="read-more" href="2013/01/22/hello-world">Read more</a>
    </div> -->
  <!-- <div class="article-content">
    <p>So I finally got around to putting something of my own up.</p>
<p>My intentions are mainly to use this space as a way to document mini projects that I'm working on, so plan on it being pretty programming, data, visualization, and statistics heavy - I get bored if I'm not learning something new or doing something I find challenging.  That said, I'm known to go on tangents about music and beer (and whatever else I feel like ranting about at the time).</p>
<p>There's also a high likelihood that I'll constantly be tweaking the layout of the site - hopefully the four people reading won't mind.</p>
  </div> -->
  <hr class="large">
  
  
		</section>

		<footer class="twelve columns offset-by-one">
			<!-- <hr class="small"> -->
			<p>Generated with <a href="http://getpelican.com">Pelican</a>. Layout done with <a href="http://getskeleton.com">Skeleton</a>. Icons are <a href="http://fortawesome.github.com/Font-Awesome/">Font Awesome</a>. Hosted on <a href="http://aws.amazon.com/s3/">S3</a>.
		</footer>
		
	</div><!-- container -->

<!-- Google Analytics -->
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34295039-1']);
  _gaq.push(['_setDomainName', 'gregreda.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

	<!-- <script type="text/javascript">
		$(document).ready(function() {
			$("a").click(function() {
				trackOutboundLink(this, "Outbound Links", this.href.toString());
				return false;
			})
		})
	</script> -->

<!-- End Document
================================================== -->
</body>
</html>